#include <consensus/hotstuff/types.h>
#include <consensus/hotstuff/utils.h>

namespace shardora {

namespace hotstuff {

std::string GetTxMessageHash(const block::protobuf::BlockTx& tx_info) {
    std::string message;
    message.reserve(tx_info.ByteSizeLong());
    message.append(tx_info.gid());
    message.append(tx_info.from());
    message.append(tx_info.to());
    uint64_t amount = tx_info.amount();
    message.append(std::string((char*)&amount, sizeof(amount)));
    uint64_t gas_limit = tx_info.gas_limit();
    message.append(std::string((char*)&gas_limit, sizeof(gas_limit)));
    uint64_t gas_price = tx_info.gas_price();
    message.append(std::string((char*)&gas_price, sizeof(gas_price)));
    uint32_t step = tx_info.step();
    message.append(std::string((char*)&step, sizeof(step)));
    // TODO 加上 gas_used 和 status 之后 100 节点共识发生卡顿，频繁超时
    uint64_t gas_used = tx_info.gas_used();
    message.append(std::string((char*)&gas_used, sizeof(gas_used)));
    uint32_t status = tx_info.status();
    message.append(std::string((char*)&status, sizeof(status)));
    for (int32_t i = 0; i < tx_info.storages_size(); ++i) {
        message.append(tx_info.storages(i).key());
        message.append(tx_info.storages(i).value());
        ZJC_DEBUG("add tx key: %s, %s, val: %s",
            tx_info.storages(i).key().c_str(),
            common::Encode::HexEncode(tx_info.storages(i).key()).c_str(), 
            common::Encode::HexEncode(tx_info.storages(i).value()).c_str());
    }

    ZJC_DEBUG("gid: %s, from: %s, to: %s, amount: %lu, gas_limit: %lu, "
        "gas_price: %lu, step: %u, gas_used: %lu, status: %lu, block tx hash: %s, message: %s",
        common::Encode::HexEncode(tx_info.gid()).c_str(),
        common::Encode::HexEncode(tx_info.from()).c_str(),
        common::Encode::HexEncode(tx_info.to()).c_str(),
        amount, gas_limit, gas_price, step,
        gas_used,
        status,
        common::Encode::HexEncode(common::Hash::keccak256(message)).c_str(),
        common::Encode::HexEncode(message).c_str());

    return common::Hash::keccak256(message);
}
add tx key: Háê¹l<9e>u<9d>ª:ÿ<82>´^NwÍaZAÕars_create_single_sign_1, 48e1eab96c9e759daa3aff82b40e77cd615a41d56172735f6372656174655f73696e676c655f7369676e5f31, val: 30312c386131613435316338336364363461346165363165653335323565356130383730343634323961623236356534363538613532656363346334646432313330363731366533663563626562663034633638336633333466633164666333643266653266663233373061613438663834643134383131633466363562396330393030302c353135666636336163303831626431316332333831333665393736383339646166643863353834333062666236633365663335613038396530656438316565663961313538666465393738363833353062393138626166616463363136343232636132333032376565396431346337636361343435353665393836623566353530312c353163643139356135313537386432663634616239386536333666323833323632656639393934653234393830363535336635313566303331343561393566393563613032646337383564336339633264633461313066333934643538333265646530333364306135636364623633643832313964376433613864663535343632646564333236653132306338306538353564353137656338363839383666343433653833323531323330663632326266656166313564366439643161393530363736346533356463346338643364336533633832393563303666636666316337316166613964323237333832313461306536313336656565386338643138372c383565633164623634353263666564663766656230636364613361333938653737306365396666346565396332366137633233633730306262386130336232613333376538353361643364363434383235333165356230626137613664356437346638346330633031666132393863663333643662633534343938393038613331356639393862363563643933363037373933666565303935376433343766633063333763343633363731656635303138656639383331336536393432613935666665306462663266613864303461626338393462393530386436663138323462396462303539613963363639316263313137313438653437303665323539612c343136393139613437666337633033393636653362656461313763313230376666323535333230352c323938313637653662633561396662303765356465376533653965623162386165343338643465652c
2024-11-19 11:42:54,348 [DEBUG] [utils.cc][GetTxMessageHash][45] gid: dc06f7d7a1d8ee64c43bd81be761f789edd0b2d19ae6f560f72c61e5abab5569, from: 44a5c714cb3f502fb77618a4a0353d96148fde7e, to: 48e1eab96c9e759daa3aff82b40e77cd615a41d5, amount: 0, gas_limit: 90000000000, gas_price: 1, step: 8, gas_used: 21733, status: 0, block tx hash: 03eeb9fd8f0eff12a2650fb506412865c7c8fdbdc33071cff59c988748ea656f, message: dc06f7d7a1d8ee64c43bd81be761f789edd0b2d19ae6f560f72c61e5abab556944a5c714cb3f502fb77618a4a0353d96148fde7e48e1eab96c9e759daa3aff82b40e77cd615a41d5000000000000000000046bf414000000010000000000000008000000e5540000000000000000000048e1eab96c9e759daa3aff82b40e77cd615a41d56172735f6372656174655f73696e676c655f7369676e5f3130312c386131613435316338336364363461346165363165653335323565356130383730343634323961623236356534363538613532656363346334646432313330363731366533663563626562663034633638336633333466633164666333643266653266663233373061613438663834643134383131633466363562396330393030302c353135666636336163303831626431316332333831333665393736383339646166643863353834333062666236633365663335613038396530656438316565663961313538666465393738363833353062393138626166616463363136343232636132333032376565396431346337636361343435353665393836623566353530312c353163643139356135313537386432663634616239386536333666323833323632656639393934653234393830363535336635313566303331343561393566393563613032646337383564336339633264633461313066333934643538333265646530333364306135636364623633643832313964376433613864663535343632646564333236653132306338306538353564353137656338363839383666343433653833323531323330663632326266656166313564366439643161393530363736346533356463346338643364336533633832393563303666636666316337316166613964323237333832313461306536313336656565386338643138372c383565633164623634353263666564663766656230636364613361333938653737306365396666346565396332366137633233633730306262386130336232613333376538353361643364363434383235333165356230626137613664356437346638346330633031666132393863663333643662633534343938393038613331356639393862363563643933363037373933666565303935376433343766633063333763343633363731656635303138656639383331336536393432613935666665306462663266613864303461626338393462393530386436663138323462396462303539613963363639316263313137313438653437303665323539612c343136393139613437666337633033393636653362656461313763313230376666323535333230352c323938313637653662633561396662303765356465376533653965623162386165343338643465652c
2024-11-19 11:42:54,348 [DEBUG] [utils.cc][GetBlockHash][65] get block hash txs message: 03eeb9fd8f0eff12a2650fb506412865c7c8fdbdc33071cff59c988748ea656f, vss_random: 0, height: 18, tm height: 1, tm: 1731987772752, invalid hash size: 0
2024-11-19 11:42:54,348 [DEBUG] [utils.cc][GetBlockHash][95] get block hash: f5a2516b5bba5235ffb643fb4fd13ee0f355ce14e34af3a67ce7b8bad330c8af, sharding_id: 3, pool_index: 15, parent_hash: f1f85a49cd970b0ac2e053f47ee2f9444775ea3b307952f89412820fcaa4c105, vss_random: 0, height: 18, timeblock_height: 1, timestamp: 1731987772752, msg: 03eeb9fd8f0eff12a2650fb506412865c7c8fdbdc33071cff59c988748ea656f030000000f000000f1f85a49cd970b0ac2e053f47ee2f9444775ea3b307952f89412820fcaa4c1050000000000000000120000000000000001000000000000005015844293010000


add tx key: Háê¹l<9e>u<9d>ª:ÿ<82>´^NwÍaZAÕars_create_single_sign_1, 48e1eab96c9e759daa3aff82b40e77cd615a41d56172735f6372656174655f73696e676c655f7369676e5f31, val: 30312c386131613435316338336364363461346165363165653335323565356130383730343634323961623236356534363538613532656363346334646432313330363731366533663563626562663034633638336633333466633164666333643266653266663233373061613438663834643134383131633466363562396330393030302c346533656131333931623161383134623432383633343435653639343639323039303437316338383832306332663634373432306131666131353332626564626632393166646663393662366333666161663065646338666463353535626361336535666462353264636366333566663237616261343961653365376333663930302c353163643139356135313537386432663634616239386536333666323833323632656639393934653234393830363535336635313566303331343561393566393563613032646337383564336339633264633461313066333934643538333265646530333364306135636364623633643832313964376433613864663535343632646564333236653132306338306538353564353137656338363839383666343433653833323531323330663632326266656166313564366439643161393530363736346533356463346338643364336533633832393563303666636666316337316166613964323237333832313461306536313336656565386338643138372c383565633164623634353263666564663766656230636364613361333938653737306365396666346565396332366137633233633730306262386130336232613333376538353361643364363434383235333165356230626137613664356437346638346330633031666132393863663333643662633534343938393038613331356639393862363563643933363037373933666565303935376433343766633063333763343633363731656635303138656639383331336536393432613935666665306462663266613864303461626338393462393530386436663138323462396462303539613963363639316263313137313438653437303665323539612c343136393139613437666337633033393636653362656461313763313230376666323535333230352c323938313637653662633561396662303765356465376533653965623162386165343338643465652c
2024-11-19 11:42:52,858 [DEBUG] [utils.cc][GetTxMessageHash][45] gid: dc06f7d7a1d8ee64c43bd81be761f789edd0b2d19ae6f560f72c61e5abab5569, from: 44a5c714cb3f502fb77618a4a0353d96148fde7e, to: 48e1eab96c9e759daa3aff82b40e77cd615a41d5, amount: 0, gas_limit: 90000000000, gas_price: 1, step: 8, gas_used: 21733, status: 0, block tx hash: 877fefc0cec5667149c395155f1acca629ab3e9373f8c1f27dd4e933282f8d7e, message: dc06f7d7a1d8ee64c43bd81be761f789edd0b2d19ae6f560f72c61e5abab556944a5c714cb3f502fb77618a4a0353d96148fde7e48e1eab96c9e759daa3aff82b40e77cd615a41d5000000000000000000046bf414000000010000000000000008000000e5540000000000000000000048e1eab96c9e759daa3aff82b40e77cd615a41d56172735f6372656174655f73696e676c655f7369676e5f3130312c386131613435316338336364363461346165363165653335323565356130383730343634323961623236356534363538613532656363346334646432313330363731366533663563626562663034633638336633333466633164666333643266653266663233373061613438663834643134383131633466363562396330393030302c346533656131333931623161383134623432383633343435653639343639323039303437316338383832306332663634373432306131666131353332626564626632393166646663393662366333666161663065646338666463353535626361336535666462353264636366333566663237616261343961653365376333663930302c353163643139356135313537386432663634616239386536333666323833323632656639393934653234393830363535336635313566303331343561393566393563613032646337383564336339633264633461313066333934643538333265646530333364306135636364623633643832313964376433613864663535343632646564333236653132306338306538353564353137656338363839383666343433653833323531323330663632326266656166313564366439643161393530363736346533356463346338643364336533633832393563303666636666316337316166613964323237333832313461306536313336656565386338643138372c383565633164623634353263666564663766656230636364613361333938653737306365396666346565396332366137633233633730306262386130336232613333376538353361643364363434383235333165356230626137613664356437346638346330633031666132393863663333643662633534343938393038613331356639393862363563643933363037373933666565303935376433343766633063333763343633363731656635303138656639383331336536393432613935666665306462663266613864303461626338393462393530386436663138323462396462303539613963363639316263313137313438653437303665323539612c343136393139613437666337633033393636653362656461313763313230376666323535333230352c323938313637653662633561396662303765356465376533653965623162386165343338643465652c
2024-11-19 11:42:52,858 [DEBUG] [utils.cc][GetBlockHash][65] get block hash txs message: 877fefc0cec5667149c395155f1acca629ab3e9373f8c1f27dd4e933282f8d7e, vss_random: 0, height: 18, tm height: 1, tm: 1731987772752, invalid hash size: 0
2024-11-19 11:42:52,858 [DEBUG] [utils.cc][GetBlockHash][95] get block hash: 771a46491cf21cbee0316065161fe4393cf893e30de552cb3280549d337556db, sharding_id: 3, pool_index: 15, parent_hash: f1f85a49cd970b0ac2e053f47ee2f9444775ea3b307952f89412820fcaa4c105, vss_random: 0, height: 18, timeblock_height: 1, timestamp: 1731987772752, msg: 877fefc0cec5667149c395155f1acca629ab3e9373f8c1f27dd4e933282f8d7e030000000f000000f1f85a49cd970b0ac2e053f47ee2f9444775ea3b307952f89412820fcaa4c1050000000000000000120000000000000001000000000000005015844293010000



single sign success: 1, 01,8a1a451c83cd64a4ae61ee3525e5a087046429ab265e4658a52ecc4c4dd21306716e3f5cbebf04c683f334fc1dfc3d2fe2ff2370aa48f84d14811c4f65b9c09000,4e3ea1391b1a814b42863445e694692090471c88820c2f647420a1fa1532bedbf291fdfc96b6c3faaf0edc8fdc555bca3e5fdb52dccf35ff27aba49ae3e7c3f900,51cd195a51578d2f64ab98e636f283262ef9994e249806553f515f03145a95f95ca02dc785d3c9c2dc4a10f394d5832ede033d0a5ccdb63d8219d7d3a8df55462ded326e120c80e855d517ec868986f443e83251230f622bfeaf15d6d9d1a9506764e35dc4c8d3d3e3c8295c06fcff1c71afa9d22738214a0e6136eee8c8d187,85ec1db6452cfedf7feb0ccda3a398e770ce9ff4ee9c26a7c23c700bb8a03b2a337e853ad3d64482531e5b0ba7a6d5d74f84c0c01fa298cf33d6bc54498908a315f998b65cd93607793fee0957d347fc0c37c463671ef5018ef98313e6942a95ffe0dbf2fa8d04abc894b9508d6f1824b9db059a9c6691bc117148e4706e259a,416919a47fc7c03966e3beda17c1207ff2553205,298167e6bc5a9fb07e5de7e3e9eb1b8ae438d4ee,, from: 48e1eab96c9e759daa3aff82b40e77cd615a41d5, key: ars_create_single_sign_1
single sign success: 1, 01,8a1a451c83cd64a4ae61ee3525e5a087046429ab265e4658a52ecc4c4dd21306716e3f5cbebf04c683f334fc1dfc3d2fe2ff2370aa48f84d14811c4f65b9c09000,62fcb25862d4bd800f4a5f3f568da31f2ae2978e5b21916d420392e2388e21ba2194681db6fa88984c9f21cc84b9e1a1b8629929188b9d6fe33ff555d62c830000,51cd195a51578d2f64ab98e636f283262ef9994e249806553f515f03145a95f95ca02dc785d3c9c2dc4a10f394d5832ede033d0a5ccdb63d8219d7d3a8df55462ded326e120c80e855d517ec868986f443e83251230f622bfeaf15d6d9d1a9506764e35dc4c8d3d3e3c8295c06fcff1c71afa9d22738214a0e6136eee8c8d187,85ec1db6452cfedf7feb0ccda3a398e770ce9ff4ee9c26a7c23c700bb8a03b2a337e853ad3d64482531e5b0ba7a6d5d74f84c0c01fa298cf33d6bc54498908a315f998b65cd93607793fee0957d347fc0c37c463671ef5018ef98313e6942a95ffe0dbf2fa8d04abc894b9508d6f1824b9db059a9c6691bc117148e4706e259a,416919a47fc7c03966e3beda17c1207ff2553205,298167e6bc5a9fb07e5de7e3e9eb1b8ae438d4ee,, from: 48e1eab96c9e759daa3aff82b40e77cd615a41d5, key: ars_create_single_sign_1



single sign message: delta_prime_i: [7233020953555105653852730162961480003272459242754704319507218951628270286152523192795841111894046695348956662250216660078418698298237656379197701362401424, 5874632259803119958551866415386460501370136843272243484425792462335495838983192629631272670329191191581677528193325015744354039857462112051526050622881672], y_prime_i: [4098004711518409257378600813734124239864746085824447350734486687297211035213870540555081465767960416740498860254334305927206101080024712775009828124214265, 5219680427877618873594796089625150806006112207351583902472962200669724120934396015538835236095999792763887266105867393369229185838053217682654232435826966], t1: [4284274806137071921631758656230770925926183608215773600296187968108444262192081929952228373688695059648265372443721175444880607663938158680167885517575494, 2405368638058561867416090813246054024601294420203375879643404247679705014768210322827505022588856959009475549147693195311655937322569030334319790723223943], t2: [7014081469932483809285421743752561230216078616559523532386869127958507703326695903578861453299444828782983651877589569100350095482018858098911021873301667, 1150923428358538468369154772454390142100117640051793626218631131748844140449421433880000249560083025907712934521407525904161606537146060152089233295549850], s1: 373428212132700874855114485492633057874687635973, s2: 236954468815148642811292743612939290357349799150, r_i: 7faed6fbe44a625672dd468fec897c34c2882182, x_prime: 416919a47fc7c03966e3beda17c1207ff2553205, r_prime: 298167e6bc5a9fb07e5de7e3e9eb1b8ae438d4ee, yi: [42123758236024297292009748051061975682325998871569940623681541220060310227705122665308976284752122399883565564970007282244152721882756077649261225836544, 3595477777966674225363674802780665279311107648519314034786986610027065836762434333615357581752062773032138251723419664676735516070433426220058903286341738]
single sign message: delta_prime_i: [7233020953555105653852730162961480003272459242754704319507218951628270286152523192795841111894046695348956662250216660078418698298237656379197701362401424, 5874632259803119958551866415386460501370136843272243484425792462335495838983192629631272670329191191581677528193325015744354039857462112051526050622881672], y_prime_i: [4261946763213395216394099623557156547805636789077116335345983945774255883655337502561445310689340216102323527639045978274517043938239113117591758130863957, 5477299878255350980640259366031032704335618511711978502453887493322331726216533969223939263370819514091411596457173902157375974093104313417720347193940713], t1: [4284274806137071921631758656230770925926183608215773600296187968108444262192081929952228373688695059648265372443721175444880607663938158680167885517575494, 2405368638058561867416090813246054024601294420203375879643404247679705014768210322827505022588856959009475549147693195311655937322569030334319790723223943], t2: [7014081469932483809285421743752561230216078616559523532386869127958507703326695903578861453299444828782983651877589569100350095482018858098911021873301667, 1150923428358538468369154772454390142100117640051793626218631131748844140449421433880000249560083025907712934521407525904161606537146060152089233295549850], s1: 373428212132700874855114485492633057874687635973, s2: 236954468815148642811292743612939290357349799150, r_i: 7faed6fbe44a625672dd468fec897c34c2882182, x_prime: 416919a47fc7c03966e3beda17c1207ff2553205, r_prime: 298167e6bc5a9fb07e5de7e3e9eb1b8ae438d4ee, yi: [24869459585009404243020176543320143834972599960684196090007937146444766183443300222227085732656393805012507722629151441806858686869112891458891791990784, 4989304337494644562337981672612332516645190600519546420639924856492222015590713180403298911159143721244994132840709667668625173734836425126365943993423044]

std::string GetBlockHash(const view_block::protobuf::ViewBlockItem &view_block) {
    std::string msg;
    auto& block = view_block.block_info();
    msg.reserve(block.tx_list_size() * 32 + 256);
    for (int32_t i = 0; i < block.tx_list_size(); i++) {
        msg.append(GetTxMessageHash(block.tx_list(i)));
    }

    ZJC_DEBUG("get block hash txs message: %s, vss_random: %lu, height: %lu, "
        "tm height: %lu, tm: %lu, invalid hash size: %u",
        common::Encode::HexEncode(msg).c_str(), 
        block.consistency_random(), 
        block.height(), 
        block.timeblock_height(), 
        block.timestamp(), 
        block.change_leader_invalid_hashs_size());
    uint32_t sharding_id = view_block.qc().network_id();
    msg.append((char*)&sharding_id, sizeof(sharding_id));
    uint32_t pool_index = view_block.qc().pool_index();
    msg.append((char*)&pool_index, sizeof(pool_index));
    msg.append(view_block.parent_hash());
    uint64_t vss_random = block.consistency_random();
    msg.append((char*)&vss_random, sizeof(vss_random));
    uint64_t height = block.height();
    msg.append((char*)&height, sizeof(height));
    uint64_t timeblock_height = block.timeblock_height();
    msg.append((char*)&timeblock_height, sizeof(timeblock_height));
    uint64_t timestamp = block.timestamp();
    msg.append((char*)&timestamp, sizeof(timestamp));  
    // msg.append(block.leader_ip());
    // msg.append((char*)&leader_port, sizeof(leader_port));
    if (block.change_leader_invalid_hashs_size() > 0) {
        for (int32_t i = 0; i < block.change_leader_invalid_hashs_size(); ++i) {
            msg.append(block.change_leader_invalid_hashs(i));
        }
    }

    auto hash = common::Hash::keccak256(msg);
    ZJC_DEBUG("get block hash: %s, sharding_id: %u, pool_index: %u, "
        "parent_hash: %s, vss_random: %lu, height: %lu, "
        "timeblock_height: %lu, timestamp: %lu, msg: %s",
        common::Encode::HexEncode(hash).c_str(),
        sharding_id, pool_index, 
        common::Encode::HexEncode(view_block.parent_hash()).c_str(), 
        vss_random, height, timeblock_height, timestamp,
        common::Encode::HexEncode(msg).c_str());
    return hash;
}

} // namespace consensus

} // namespace shardora


