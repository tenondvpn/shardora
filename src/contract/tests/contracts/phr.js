const Web3 = require('web3')
var net = require('net');
var web3 = new Web3(new Web3.providers.IpcProvider('/Users/myuser/Library/Ethereum/geth.ipc', net)); // mac os path
const { randomBytes } = require('crypto')
const Secp256k1 = require('./secp256k1_1')
const keccak256 = require('keccak256')
var querystring = require('querystring');
var http = require('http');
var fs = require('fs');

var self_private_key = null;
var self_public_key = null;
var local_count_shard_id = 3;
var contract_address = null;

function str_to_hex(str) {
    var arr1 = [];
    for (var n = 0; n < str.length; n++) {
        var hex = Number(str.charCodeAt(n)).toString(16);
        arr1.push(hex);
    }
    return arr1.join('');
}

function hexToBytes(hex) {
    for (var bytes = [], c = 0; c < hex.length; c += 2)
        bytes.push(parseInt(hex.substr(c, 2), 16));
    return bytes;
}

function init_private_key() {
    const privateKeyBuf = Secp256k1.uint256("fa04ebee157c6c10bd9d250fc2c938780bf68cbe30e9f0d7c048e4d081907971", 16)
    self_private_key = Secp256k1.uint256(privateKeyBuf, 16)
    self_public_key = Secp256k1.generatePublicKeyFromPrivateKeyData(self_private_key)
    var pk_bytes = hexToBytes(self_public_key.x.toString(16) + self_public_key.y.toString(16))
    var address = keccak256(pk_bytes).toString('hex')
    console.log("self_account_id: " + address.toString('hex'));
    address = address.slice(address.length - 40, address.length)
    self_account_id = address;
    contract_address = fs.readFileSync('contract_address', 'utf-8');
    console.log("contract_address: " + contract_address);
}

function PostCode(data) {
    var post_data = querystring.stringify(data);
    var post_options = {
        host: '127.0.0.1',
        port: '8781',
        path: '/transaction',
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Content-Length': Buffer.byteLength(post_data)
        }
    };

    var post_req = http.request(post_options, function (res) {
        res.setEncoding('utf8');
        res.on('data', function (chunk) {
            if (chunk != "ok") {
                console.log('Response: ' + chunk + ", " + data);
            } else {
                console.log('Response: ' + chunk + ", " + data);
            }
        })
    });

    //console.log("req data: " + post_data);
    post_req.write(post_data);
    post_req.end();
}

function GetValidHexString(uint256_bytes) {
    var str_res = uint256_bytes.toString(16)
    while (str_res.length < 64) {
        str_res = "0" + str_res;
    }

    return str_res;
}

function create_contract(gid, to, amount, gas_limit, gas_price, contract_bytes, input, prepay) {
    var gid = GetValidHexString(Secp256k1.uint256(randomBytes(32)));
    var tx_type = 6;
    var frompk = '04' + self_public_key.x.toString(16) + self_public_key.y.toString(16);
    const MAX_UINT32 = 0xFFFFFFFF;
    var amount_buf = new Buffer(8);
    var big = ~~(amount / MAX_UINT32)
    var low = (amount % MAX_UINT32) - big
    amount_buf.writeUInt32LE(big, 4)
    amount_buf.writeUInt32LE(low, 0)

    var gas_limit_buf = new Buffer(8);
    var big = ~~(gas_limit / MAX_UINT32)
    var low = (gas_limit % MAX_UINT32) - big
    gas_limit_buf.writeUInt32LE(big, 4)
    gas_limit_buf.writeUInt32LE(low, 0)

    var gas_price_buf = new Buffer(8);
    var big = ~~(gas_price / MAX_UINT32)
    var low = (gas_price % MAX_UINT32) - big
    gas_price_buf.writeUInt32LE(big, 4)
    gas_price_buf.writeUInt32LE(low, 0)

    var step_buf = new Buffer(8);
    var big = ~~(tx_type / MAX_UINT32)
    var low = (tx_type % MAX_UINT32) - big
    step_buf.writeUInt32LE(big, 0)
    step_buf.writeUInt32LE(low, 0)

    var prepay_buf = new Buffer(8);
    var big = ~~(prepay / MAX_UINT32)
    var low = (prepay % MAX_UINT32) - big
    prepay_buf.writeUInt32LE(big, 4)
    prepay_buf.writeUInt32LE(low, 0)

    const message_buf = Buffer.concat([Buffer.from(gid, 'hex'), Buffer.from(frompk, 'hex'), Buffer.from(to, 'hex'),
        amount_buf, gas_limit_buf, gas_price_buf, step_buf, Buffer.from(contract_bytes, 'hex'), Buffer.from(input, 'hex'), prepay_buf]);
    //var arrByte = Uint8Array.from(message_buf)
    var kechash = keccak256(message_buf)

    var digest = Secp256k1.uint256(kechash, 16)
    const sig = Secp256k1.ecsign(self_private_key, digest)
    const sigR = Secp256k1.uint256(sig.r, 16)
    const sigS = Secp256k1.uint256(sig.s, 16)
    const pubX = Secp256k1.uint256(self_public_key.x, 16)
    const pubY = Secp256k1.uint256(self_public_key.y, 16)
    const isValidSig = Secp256k1.ecverify(pubX, pubY, sigR, sigS, digest)
    console.log("digest: " + digest)
    console.log("sigr: " + sigR.toString(16))
    console.log("sigs: " + sigS.toString(16))
    if (!isValidSig) {
        console.log('signature transaction failed.')
        return;
    }

    return {
        'gid': gid,
        'pubkey': '04' + self_public_key.x.toString(16) + self_public_key.y.toString(16),
        'to': to,
        'amount': amount,
        'gas_limit': gas_limit,
        'gas_price': gas_price,
        'type': tx_type,
        'shard_id': local_count_shard_id,
        'hash': kechash,
        'attrs_size': 4,
        "bytes_code": contract_bytes,
        "input": input,
        "pepay": prepay,
        'sign_r': sigR.toString(16),
        'sign_s': sigS.toString(16),
        'sign_v': sig.v,
    }
}

function create_tx(to, amount, gas_limit, gas_price) {
    var gid = GetValidHexString(Secp256k1.uint256(randomBytes(32)));
    var tx_type = 0;
    var frompk = '04' + self_public_key.x.toString(16) + self_public_key.y.toString(16);
    const MAX_UINT32 = 0xFFFFFFFF;
    var amount_buf = new Buffer(8);
    var big = ~~(amount / MAX_UINT32)
    var low = (amount % MAX_UINT32) - big
    amount_buf.writeUInt32LE(big, 4)
    amount_buf.writeUInt32LE(low, 0)

    var gas_limit_buf = new Buffer(8);
    var big = ~~(gas_limit / MAX_UINT32)
    var low = (gas_limit % MAX_UINT32) - big
    gas_limit_buf.writeUInt32LE(big, 4)
    gas_limit_buf.writeUInt32LE(low, 0)

    var gas_price_buf = new Buffer(8);
    var big = ~~(gas_price / MAX_UINT32)
    var low = (gas_price % MAX_UINT32) - big
    gas_price_buf.writeUInt32LE(big, 4)
    gas_price_buf.writeUInt32LE(low, 0)
    var step_buf = new Buffer(8);
    var big = ~~(tx_type / MAX_UINT32)
    var low = (tx_type % MAX_UINT32) - big
    step_buf.writeUInt32LE(big, 0)
    step_buf.writeUInt32LE(low, 0)

    const message_buf = Buffer.concat([Buffer.from(gid, 'hex'), Buffer.from(frompk, 'hex'), Buffer.from(to, 'hex'),
        amount_buf, gas_limit_buf, gas_price_buf, step_buf]);
    var kechash = keccak256(message_buf)
    var digest = Secp256k1.uint256(kechash, 16)
    const sig = Secp256k1.ecsign(self_private_key, digest)
    const sigR = Secp256k1.uint256(sig.r, 16)
    const sigS = Secp256k1.uint256(sig.s, 16)
    const pubX = Secp256k1.uint256(self_public_key.x, 16)
    const pubY = Secp256k1.uint256(self_public_key.y, 16)
    return {
        'gid': gid,
        'pubkey': '04' + self_public_key.x.toString(16) + self_public_key.y.toString(16),
        'to': to,
        'amount': amount,
        'gas_limit': gas_limit,
        'gas_price': gas_price,
        'type': tx_type,
        'shard_id': local_count_shard_id,
        'sign_r': sigR.toString(16),
        'sign_s': sigS.toString(16),
        'sign_v': sig.v,
    }
}

function new_contract(contract_bytes) {
    var gid = GetValidHexString(Secp256k1.uint256(randomBytes(32)));
    var kechash = keccak256(self_account_id + gid + contract_bytes).toString('hex')
    var self_contract_address = kechash.slice(kechash.length - 40, kechash.length)
    var data = create_contract(
        gid,
        self_contract_address,
        0,
        10000000,
        1,
        contract_bytes,
        "",
        999999999);
    PostCode(data);

    const opt = { flag: 'w', }
    fs.writeFile('contract_address', self_contract_address, opt, (err) => {
        if (err) {
            console.error(err)
        }
    })
}

function do_transaction(to_addr, amount, gas_limit, gas_price) {
    var data = create_tx(to_addr, amount, gas_limit, gas_price);
    PostCode(data);
}

function CreatePhr() {
    console.log("test smart contract signature: ");
    var account1 = web3.eth.accounts.privateKeyToAccount('0x20ac5391ad70648f4ac6ee659e7709c0305c91c968c91b45018673ba5d1841e5');
    console.log("account1 :");
    console.log(account1.address);
    var account2 = web3.eth.accounts.privateKeyToAccount('0x748f7eaad8be6841490a134e0518dafdf67714a73d1275f917475abeb504dc05');
    console.log("account2 :");
    console.log(account2.address);
    var account3 = web3.eth.accounts.privateKeyToAccount('0xb546fd36d57b4c9adda29967cf6a1a3e3478f9a4892394e17225cfb6c0d1d1e5');
    console.log("account3 :");
    console.log(account3.address);

    var cons_codes = web3.eth.abi.encodeParameters(['address[]'],
        [[account1.address,
        account2.address,
        account3.address]]);
    console.log("cons_codes: " + cons_codes.substring(2));


    // func code
    var ResAddFunc = web3.eth.abi.encodeFunctionSignature('ResAdd(bytes32,bytes,bytes)');
    var ResAddFunc_param_codes = web3.eth.abi.encodeParameters(['bytes32', 'bytes', 'bytes'], ['0x20ac5391ad70648f4ac6ee659e7709c0305c91c968c91b45018673ba5d1841e5', '0x20ac5391ad70648f4ac6ee659e7709c0305c91c968c91b45018673ba5d1841e5', '0x20ac5391ad70648f4ac6ee659e7709c0305c91c968c91b45018673ba5d1841e5']);
    console.log("ResAddFunc: " + ResAddFunc.substring(2) + ResAddFunc_param_codes.substring(2));

    var AttrReg = web3.eth.abi.encodeFunctionSignature('AttrReg(bytes,bytes32,bytes[])');
    var test_attr = "test_attr";
    var test_attr_hash = web3.utils.keccak256(test_attr);

    var sig1 = web3.eth.accounts.sign(test_attr_hash, '0x20ac5391ad70648f4ac6ee659e7709c0305c91c968c91b45018673ba5d1841e5');
    var sig2 = web3.eth.accounts.sign(test_attr_hash, '0x748f7eaad8be6841490a134e0518dafdf67714a73d1275f917475abeb504dc05');
    var sig3 = web3.eth.accounts.sign(test_attr_hash, '0xb546fd36d57b4c9adda29967cf6a1a3e3478f9a4892394e17225cfb6c0d1d1e5');
    var AttrReg_param_codes = web3.eth.abi.encodeParameters(['bytes', 'bytes32', 'bytes[]'], ['0x20ac5391ad70648f4ac6ee659e7709c0305c91c968c91b45018673ba5d1841e5', test_attr_hash, [sig1.signature, sig2.signature, sig3.signature]]);
    console.log("AttrReg: " + AttrReg.substring(2) + AttrReg_param_codes.substring(2));
}

init_private_key();
const args = process.argv.slice(2)
if (args[0] == 0) {
    do_transaction(args[1], 100000, 100000, 1);
}

if (args[0] == 1) {
    new_contract("60806040523480156200001157600080fd5b506040516200133d3803806200133d8339818101604052810190620000379190620002f3565b80600090805190602001906200004f92919062000057565b505062000344565b828054828255906000526020600020908101928215620000d3579160200282015b82811115620000d25782518260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055509160200191906001019062000078565b5b509050620000e29190620000e6565b5090565b5b8082111562000101576000816000905550600101620000e7565b5090565b6000604051905090565b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b62000169826200011e565b810181811067ffffffffffffffff821117156200018b576200018a6200012f565b5b80604052505050565b6000620001a062000105565b9050620001ae82826200015e565b919050565b600067ffffffffffffffff821115620001d157620001d06200012f565b5b602082029050602081019050919050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006200021482620001e7565b9050919050565b620002268162000207565b81146200023257600080fd5b50565b60008151905062000246816200021b565b92915050565b6000620002636200025d84620001b3565b62000194565b90508083825260208201905060208402830185811115620002895762000288620001e2565b5b835b81811015620002b65780620002a1888262000235565b8452602084019350506020810190506200028b565b5050509392505050565b600082601f830112620002d857620002d762000119565b5b8151620002ea8482602086016200024c565b91505092915050565b6000602082840312156200030c576200030b6200010f565b5b600082015167ffffffffffffffff8111156200032d576200032c62000114565b5b6200033b84828501620002c0565b91505092915050565b610fe980620003546000396000f3fe608060405234801561001057600080fd5b50600436106100575760003560e01c80635f13d6ee1461005c578063691b34631461008c5780637e280378146100a8578063b105ef33146100d9578063fdba8f1114610109575b600080fd5b61007660048036038101906100719190610573565b610125565b60405161008391906105e1565b60405180910390f35b6100a660048036038101906100a19190610778565b610164565b005b6100c260048036038101906100bd9190610803565b6101c0565b6040516100d09291906108af565b60405180910390f35b6100f360048036038101906100ee91906108e6565b6102f4565b6040516101009190610951565b60405180910390f35b610123600480360381019061011e9190610a52565b61033b565b005b6000818154811061013557600080fd5b906000526020600020016000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6040518060400160405280838152602001828152506001600085815260200190815260200160002060008201518160000190816101a19190610ce9565b5060208201518160010190816101b79190610ce9565b50905050505050565b60016020528060005260406000206000915090508060000180546101e390610b0c565b80601f016020809104026020016040519081016040528092919081815260200182805461020f90610b0c565b801561025c5780601f106102315761010080835404028352916020019161025c565b820191906000526020600020905b81548152906001019060200180831161023f57829003601f168201915b50505050509080600101805461027190610b0c565b80601f016020809104026020016040519081016040528092919081815260200182805461029d90610b0c565b80156102ea5780601f106102bf576101008083540402835291602001916102ea565b820191906000526020600020905b8154815290600101906020018083116102cd57829003601f168201915b5050505050905082565b600282805160208101820180518482526020830160208501208183528095505050505050818154811061032657600080fd5b90600052602060002001600091509150505481565b80516000805490501461034d57600080fd5b60005b815181101561040d576000818154811061036d5761036c610dbb565b5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166103da6103ba85610458565b8484815181106103cd576103cc610dbb565b5b6020026020010151610488565b73ffffffffffffffffffffffffffffffffffffffff16146103fa57600080fd5b808061040590610e19565b915050610350565b5060028360405161041e9190610e9d565b9081526020016040518091039020829080600181540180825580915050600190039060005260206000200160009091909190915055505050565b60008160405160200161046b9190610f2c565b604051602081830303815290604052805190602001209050919050565b600080600080610497856104f7565b925092509250600186848484604051600081526020016040526040516104c09493929190610f6e565b6020604051602081039080840390855afa1580156104e2573d6000803e3d6000fd5b50505060206040510351935050505092915050565b6000806000604184511461050a57600080fd5b6020840151915060408401519050606084015160001a92509193909250565b6000604051905090565b600080fd5b600080fd5b6000819050919050565b6105508161053d565b811461055b57600080fd5b50565b60008135905061056d81610547565b92915050565b60006020828403121561058957610588610533565b5b60006105978482850161055e565b91505092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006105cb826105a0565b9050919050565b6105db816105c0565b82525050565b60006020820190506105f660008301846105d2565b92915050565b6000819050919050565b61060f816105fc565b811461061a57600080fd5b50565b60008135905061062c81610606565b92915050565b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6106858261063c565b810181811067ffffffffffffffff821117156106a4576106a361064d565b5b80604052505050565b60006106b7610529565b90506106c3828261067c565b919050565b600067ffffffffffffffff8211156106e3576106e261064d565b5b6106ec8261063c565b9050602081019050919050565b82818337600083830152505050565b600061071b610716846106c8565b6106ad565b90508281526020810184848401111561073757610736610637565b5b6107428482856106f9565b509392505050565b600082601f83011261075f5761075e610632565b5b813561076f848260208601610708565b91505092915050565b60008060006060848603121561079157610790610533565b5b600061079f8682870161061d565b935050602084013567ffffffffffffffff8111156107c0576107bf610538565b5b6107cc8682870161074a565b925050604084013567ffffffffffffffff8111156107ed576107ec610538565b5b6107f98682870161074a565b9150509250925092565b60006020828403121561081957610818610533565b5b60006108278482850161061d565b91505092915050565b600081519050919050565b600082825260208201905092915050565b60005b8381101561086a57808201518184015260208101905061084f565b60008484015250505050565b600061088182610830565b61088b818561083b565b935061089b81856020860161084c565b6108a48161063c565b840191505092915050565b600060408201905081810360008301526108c98185610876565b905081810360208301526108dd8184610876565b90509392505050565b600080604083850312156108fd576108fc610533565b5b600083013567ffffffffffffffff81111561091b5761091a610538565b5b6109278582860161074a565b92505060206109388582860161055e565b9150509250929050565b61094b816105fc565b82525050565b60006020820190506109666000830184610942565b92915050565b600067ffffffffffffffff8211156109875761098661064d565b5b602082029050602081019050919050565b600080fd5b60006109b06109ab8461096c565b6106ad565b905080838252602082019050602084028301858111156109d3576109d2610998565b5b835b81811015610a1a57803567ffffffffffffffff8111156109f8576109f7610632565b5b808601610a05898261074a565b855260208501945050506020810190506109d5565b5050509392505050565b600082601f830112610a3957610a38610632565b5b8135610a4984826020860161099d565b91505092915050565b600080600060608486031215610a6b57610a6a610533565b5b600084013567ffffffffffffffff811115610a8957610a88610538565b5b610a958682870161074a565b9350506020610aa68682870161061d565b925050604084013567ffffffffffffffff811115610ac757610ac6610538565b5b610ad386828701610a24565b9150509250925092565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680610b2457607f821691505b602082108103610b3757610b36610add565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302610b9f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610b62565b610ba98683610b62565b95508019841693508086168417925050509392505050565b6000819050919050565b6000610be6610be1610bdc8461053d565b610bc1565b61053d565b9050919050565b6000819050919050565b610c0083610bcb565b610c14610c0c82610bed565b848454610b6f565b825550505050565b600090565b610c29610c1c565b610c34818484610bf7565b505050565b5b81811015610c5857610c4d600082610c21565b600181019050610c3a565b5050565b601f821115610c9d57610c6e81610b3d565b610c7784610b52565b81016020851015610c86578190505b610c9a610c9285610b52565b830182610c39565b50505b505050565b600082821c905092915050565b6000610cc060001984600802610ca2565b1980831691505092915050565b6000610cd98383610caf565b9150826002028217905092915050565b610cf282610830565b67ffffffffffffffff811115610d0b57610d0a61064d565b5b610d158254610b0c565b610d20828285610c5c565b600060209050601f831160018114610d535760008415610d41578287015190505b610d4b8582610ccd565b865550610db3565b601f198416610d6186610b3d565b60005b82811015610d8957848901518255600182019150602085019450602081019050610d64565b86831015610da65784890151610da2601f891682610caf565b8355505b6001600288020188555050505b505050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610e248261053d565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203610e5657610e55610dea565b5b600182019050919050565b600081905092915050565b6000610e7782610830565b610e818185610e61565b9350610e9181856020860161084c565b80840191505092915050565b6000610ea98284610e6c565b915081905092915050565b600081905092915050565b7f19457468657265756d205369676e6564204d6573736167653a0a333200000000600082015250565b6000610ef5601c83610eb4565b9150610f0082610ebf565b601c82019050919050565b6000819050919050565b610f26610f21826105fc565b610f0b565b82525050565b6000610f3782610ee8565b9150610f438284610f15565b60208201915081905092915050565b600060ff82169050919050565b610f6881610f52565b82525050565b6000608082019050610f836000830187610942565b610f906020830186610f5f565b610f9d6040830185610942565b610faa6060830184610942565b9594505050505056fea264697066735822122096cba0a9b12e8a45393d4980f7a84fca9dbb13571ff521215100e582485807fa64736f6c6343000811003300000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000e252d01a37b85e2007ed3cc13797aa92496204a40000000000000000000000005f15294a1918633d4dd4ec47098a14d01c58e957000000000000000000000000d45cfd6855c6ec8f635a6f2b46c647e99c59c79d");
}

if (args[0] == 2) {
    CreatePhr();
}