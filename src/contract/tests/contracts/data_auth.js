const Web3 = require('web3')
var net = require('net');
var web3 = new Web3(new Web3.providers.IpcProvider('/Users/myuser/Library/Ethereum/geth.ipc', net)); // mac os path
const { randomBytes } = require('crypto')
const Secp256k1 = require('./secp256k1_1')
const keccak256 = require('keccak256')
var querystring = require('querystring');
var http = require('http');
var fs = require('fs');

var self_private_key = null;
var self_public_key = null;
var local_count_shard_id = 3;
var contract_address = null;

function str_to_hex(str) {
    var arr1 = [];
    for (var n = 0; n < str.length; n++) {
        var hex = Number(str.charCodeAt(n)).toString(16);
        arr1.push(hex);
    }
    return arr1.join('');
}

function hexToBytes(hex) {
    for (var bytes = [], c = 0; c < hex.length; c += 2)
        bytes.push(parseInt(hex.substr(c, 2), 16));
    return bytes;
}

function init_private_key() {
    //const privateKeyBuf = Secp256k1.uint256("b5b3128c236fcec044c303b54d55a97e20bf98b625fec1de6a2a0fffcd8c7cf7", 16)
    //const privateKeyBuf = Secp256k1.uint256("1b2f993407b95324155ecbfcf2577e32174c8b66e5fdfa4da5677bccdc788763", 16)
    //const privateKeyBuf = Secp256k1.uint256("1ef07e73ed6211e7b0a512bc6468419fbdcd9b345b49a3331b4c8f8070172a70", 16)
    //const privateKeyBuf = Secp256k1.uint256("373a3165ec09edea6e7a1c8cff21b06f5fb074386ece283927aef730c6d44596", 16)
    //const privateKeyBuf = Secp256k1.uint256("fa04ebee157c6c10bd9d250fc2c938780bf68cbe30e9f0d7c048e4d081907971", 16)
    //manager
    const privateKeyBuf = Secp256k1.uint256("20ac5391ad70648f4ac6ee659e7709c0305c91c968c91b45018673ba5d1841e5", 16)
    self_private_key = Secp256k1.uint256(privateKeyBuf, 16)
    self_public_key = Secp256k1.generatePublicKeyFromPrivateKeyData(self_private_key)
    var pk_bytes = hexToBytes(self_public_key.x.toString(16) + self_public_key.y.toString(16))
    var address = keccak256(pk_bytes).toString('hex')
    console.log("self_account_id: " + address.toString('hex'));
    address = address.slice(address.length - 40, address.length)
    self_account_id = address;
    contract_address = fs.readFileSync('contract_address', 'utf-8');
    console.log("contract_address: " + contract_address);
}

function PostCode(data) {
    var post_data = querystring.stringify(data);
    var post_options = {
        host: '82.156.224.174',
        port: '8781',
        path: '/transaction',
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Content-Length': Buffer.byteLength(post_data)
        }
    };

    var post_req = http.request(post_options, function (res) {
        res.setEncoding('utf8');
        res.on('data', function (chunk) {
            if (chunk != "ok") {
                console.log('Response: ' + chunk + ", " + data);
            } else {
                console.log('Response: ' + chunk + ", " + data);
            }
        })
    });

    //console.log("req data: " + post_data);
    post_req.write(post_data);
    post_req.end();
}

function GetValidHexString(uint256_bytes) {
    var str_res = uint256_bytes.toString(16)
    while (str_res.length < 64) {
        str_res = "0" + str_res;
    }

    return str_res;
}

function param_contract(tx_type, gid, to, amount, gas_limit, gas_price, contract_bytes, input, prepay) {
    var gid = GetValidHexString(Secp256k1.uint256(randomBytes(32)));
    var frompk = '04' + self_public_key.x.toString(16) + self_public_key.y.toString(16);
    const MAX_UINT32 = 0xFFFFFFFF;
    var amount_buf = new Buffer(8);
    var big = ~~(amount / MAX_UINT32)
    var low = (amount % MAX_UINT32) - big
    amount_buf.writeUInt32LE(big, 4)
    amount_buf.writeUInt32LE(low, 0)

    var gas_limit_buf = new Buffer(8);
    var big = ~~(gas_limit / MAX_UINT32)
    var low = (gas_limit % MAX_UINT32) - big
    gas_limit_buf.writeUInt32LE(big, 4)
    gas_limit_buf.writeUInt32LE(low, 0)

    var gas_price_buf = new Buffer(8);
    var big = ~~(gas_price / MAX_UINT32)
    var low = (gas_price % MAX_UINT32) - big
    gas_price_buf.writeUInt32LE(big, 4)
    gas_price_buf.writeUInt32LE(low, 0)

    var step_buf = new Buffer(8);
    var big = ~~(tx_type / MAX_UINT32)
    var low = (tx_type % MAX_UINT32) - big
    step_buf.writeUInt32LE(big, 0)
    step_buf.writeUInt32LE(low, 0)

    var prepay_buf = new Buffer(8);
    var big = ~~(prepay / MAX_UINT32)
    var low = (prepay % MAX_UINT32) - big
    prepay_buf.writeUInt32LE(big, 4)
    prepay_buf.writeUInt32LE(low, 0)

    var message_buf = Buffer.concat([Buffer.from(gid, 'hex'), Buffer.from(frompk, 'hex'), Buffer.from(to, 'hex'),
        amount_buf, gas_limit_buf, gas_price_buf, step_buf, Buffer.from(contract_bytes, 'hex'), Buffer.from(input, 'hex'), prepay_buf]);
    var kechash = keccak256(message_buf)

    var digest = Secp256k1.uint256(kechash, 16)
    const sig = Secp256k1.ecsign(self_private_key, digest)
    const sigR = Secp256k1.uint256(sig.r, 16)
    const sigS = Secp256k1.uint256(sig.s, 16)
    const pubX = Secp256k1.uint256(self_public_key.x, 16)
    const pubY = Secp256k1.uint256(self_public_key.y, 16)
    const isValidSig = Secp256k1.ecverify(pubX, pubY, sigR, sigS, digest)
    console.log("digest: " + digest)
    console.log("sigr: " + sigR.toString(16))
    console.log("sigs: " + sigS.toString(16))
    if (!isValidSig) {
        console.log('signature transaction failed.')
        return;
    }

    return {
        'gid': gid,
        'pubkey': '04' + self_public_key.x.toString(16) + self_public_key.y.toString(16),
        'to': to,
        'amount': amount,
        'gas_limit': gas_limit,
        'gas_price': gas_price,
        'type': tx_type,
        'shard_id': local_count_shard_id,
        'hash': kechash,
        'attrs_size': 4,
        "bytes_code": contract_bytes,
        "input": input,
        "pepay": prepay,
        'sign_r': sigR.toString(16),
        'sign_s': sigS.toString(16),
        'sign_v': sig.v,
    }
}

function create_tx(to, amount, gas_limit, gas_price, prepay, tx_type) {
    var gid = GetValidHexString(Secp256k1.uint256(randomBytes(32)));
    var frompk = '04' + self_public_key.x.toString(16) + self_public_key.y.toString(16);
    const MAX_UINT32 = 0xFFFFFFFF;
    var amount_buf = new Buffer(8);
    var big = ~~(amount / MAX_UINT32)
    var low = (amount % MAX_UINT32) - big
    amount_buf.writeUInt32LE(big, 4)
    amount_buf.writeUInt32LE(low, 0)

    var gas_limit_buf = new Buffer(8);
    var big = ~~(gas_limit / MAX_UINT32)
    var low = (gas_limit % MAX_UINT32) - big
    gas_limit_buf.writeUInt32LE(big, 4)
    gas_limit_buf.writeUInt32LE(low, 0)

    var gas_price_buf = new Buffer(8);
    var big = ~~(gas_price / MAX_UINT32)
    var low = (gas_price % MAX_UINT32) - big
    gas_price_buf.writeUInt32LE(big, 4)
    gas_price_buf.writeUInt32LE(low, 0)
    var step_buf = new Buffer(8);
    var big = ~~(tx_type / MAX_UINT32)
    var low = (tx_type % MAX_UINT32) - big
    step_buf.writeUInt32LE(big, 0)
    step_buf.writeUInt32LE(low, 0)
    var prepay_buf = new Buffer(8);
    var big = ~~(prepay / MAX_UINT32)
    var low = (prepay % MAX_UINT32) - big
    prepay_buf.writeUInt32LE(big, 4)
    prepay_buf.writeUInt32LE(low, 0)

    var message_buf = Buffer.concat([Buffer.from(gid, 'hex'), Buffer.from(frompk, 'hex'), Buffer.from(to, 'hex'),
        amount_buf, gas_limit_buf, gas_price_buf, step_buf, prepay_buf]);
    var kechash = keccak256(message_buf)
    var digest = Secp256k1.uint256(kechash, 16)
    const sig = Secp256k1.ecsign(self_private_key, digest)
    const sigR = Secp256k1.uint256(sig.r, 16)
    const sigS = Secp256k1.uint256(sig.s, 16)
    const pubX = Secp256k1.uint256(self_public_key.x, 16)
    const pubY = Secp256k1.uint256(self_public_key.y, 16)
    return {
        'gid': gid,
        'pubkey': '04' + self_public_key.x.toString(16) + self_public_key.y.toString(16),
        'to': to,
        'amount': amount,
        'gas_limit': gas_limit,
        'gas_price': gas_price,
        'type': tx_type,
        'shard_id': local_count_shard_id,
        'sign_r': sigR.toString(16),
        'sign_s': sigS.toString(16),
        'sign_v': sig.v,
        'pepay': prepay
    }
}

function new_contract(contract_bytes) {
    var gid = GetValidHexString(Secp256k1.uint256(randomBytes(32)));
    var kechash = keccak256(self_account_id + gid + contract_bytes).toString('hex')
    var self_contract_address = kechash.slice(kechash.length - 40, kechash.length)
    var data = param_contract(
        6,
        gid,
        self_contract_address,
        0,
        10000000,
        1,
        contract_bytes,
        "",
        999999999);
    PostCode(data);

    const opt = { flag: 'w', }
    fs.writeFile('contract_address', self_contract_address, opt, (err) => {
        if (err) {
            console.error(err)
        }
    })
}

function call_contract(input, amount) {
    contract_address = fs.readFileSync('contract_address', 'utf-8');
    console.log("contract_address: " + contract_address);
    var gid = GetValidHexString(Secp256k1.uint256(randomBytes(32)));
    var data = param_contract(
        8,
        gid,
        contract_address,
        amount,
        90000000000,
        1,
        "",
        input,
        0);
    PostCode(data);
}

function do_transaction(to_addr, amount, gas_limit, gas_price) {
    var data = create_tx(to_addr, amount, gas_limit, gas_price, 0, 0);
    PostCode(data);
}

function CreatePhr() {
    console.log("test smart contract signature: ");
    var account1 = web3.eth.accounts.privateKeyToAccount('0x20ac5391ad70648f4ac6ee659e7709c0305c91c968c91b45018673ba5d1841e5');
    console.log("account1 :");
    console.log(account1.address);
    var account2 = web3.eth.accounts.privateKeyToAccount('0x748f7eaad8be6841490a134e0518dafdf67714a73d1275f917475abeb504dc05');
    console.log("account2 :");
    console.log(account2.address);
    var account3 = web3.eth.accounts.privateKeyToAccount('0xb546fd36d57b4c9adda29967cf6a1a3e3478f9a4892394e17225cfb6c0d1d1e5');
    console.log("account3 :");
    console.log(account3.address);

    var cons_codes = web3.eth.abi.encodeParameters(['address[]'],
        [[account1.address,
        account2.address,
            account3.address]]);
    console.log("cons_codes: " + cons_codes.substring(2));

    {
        var func = web3.eth.abi.encodeFunctionSignature('AddManager(address[])');
        var funcParam = web3.eth.abi.encodeParameters(['address[]'], [[account1.address,
            account2.address,
                account3.address]]);
        console.log("AddManager func: " + func.substring(2) + funcParam.substring(2));
    }

    {
        var func = web3.eth.abi.encodeFunctionSignature('RemoveManager(address[])');
        var funcParam = web3.eth.abi.encodeParameters(['address[]'], [[account1.address]]);
        console.log("RemoveManager func: " + func.substring(2) + funcParam.substring(2));
    }

    {
        var func = web3.eth.abi.encodeFunctionSignature('Authorization(bytes)');
        var funcParam = web3.eth.abi.encodeParameters(['bytes'], ['0x20ac5391ad70648f4ac6ee659e7709c0305c91c968c91b45018673ba5d1841e5']);
        console.log("Authorization func: " + func.substring(2) + funcParam.substring(2));
    }
    
    {
        var func = web3.eth.abi.encodeFunctionSignature('GetAuthJson()');
        console.log("GetAuthJson func: " + func.substring(2));
    }
}

function GetConstructorParams(args) {
    if (args.length < 2) {
        return;
    }

    var addrs = [];
    for (var i = 1; i < args.length; ++i) {
        if (args[i].length != 42) {
            return null;
        }

        if (!args[i].startsWith("0x")) {
            return null;
        }

        addrs.append(args[i]);
    }
    
    var cons_codes = web3.eth.abi.encodeParameters(['address[]'], [addrs]);
    console.log("cons_codes: " + cons_codes.substring(2));
    return cons_codes.substring(2);
}

function QueryPostCode(path, data) {
    var post_data = querystring.stringify(data);
    var post_options = {
        host: '82.156.224.174',
        port: '8781',
        path: path,
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Content-Length': Buffer.byteLength(post_data)
        }
    };

    var post_req = http.request(post_options, function (res) {
        res.setEncoding('utf8');
        res.on('data', function (chunk) {
            var json_res = JSON.parse(chunk)
            console.log('amount: ' + json_res.amount + ", tmp: " + json_res.tmp);
            console.log('Response: ' + chunk);
        })
    });

    post_req.write(post_data);
    post_req.end();
}

function QueryContract(input) {
    var contract_address = fs.readFileSync('contract_address', 'utf-8');
    var data = {
        "input": input,
        'address': contract_address,
        'from': self_account_id,
    };

    QueryPostCode('/query_contract', data);
}

function Prepayment(prepay) {
    var contract_address = fs.readFileSync('contract_address', 'utf-8');
    var data = create_tx(contract_address, 0, 100000, 1, prepay, 7);
    PostCode(data);
}

init_private_key();
const args = process.argv.slice(2)

console.log("args type: " + args[0] + ", size: " + args.length);
// 创建参数
if (args[0] == 0) {
    CreatePhr();
}

// 创建链上数据身份
if (args[0] == 1) {
    var cons_cods = GetConstructorParams(args);
    if (cons_cods == null) {
        console.log("创建数据身份失败，输入的初始管理员错误: " + process.argv);
        return;
    }
    
    var contract_bytes = "608060405260008055604051620022843803806200228483398181016040528101906200002d919062000361565b60008151905060005b81811015620000ca576001600360008584815181106200005b576200005a620003b2565b5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055508080620000c1906200041a565b91505062000036565b50600080819055506001600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff02191690831515021790555033600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550505062000467565b6000604051905090565b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b620001d7826200018c565b810181811067ffffffffffffffff82111715620001f957620001f86200019d565b5b80604052505050565b60006200020e62000173565b90506200021c8282620001cc565b919050565b600067ffffffffffffffff8211156200023f576200023e6200019d565b5b602082029050602081019050919050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000620002828262000255565b9050919050565b620002948162000275565b8114620002a057600080fd5b50565b600081519050620002b48162000289565b92915050565b6000620002d1620002cb8462000221565b62000202565b90508083825260208201905060208402830185811115620002f757620002f662000250565b5b835b818110156200032457806200030f8882620002a3565b845260208401935050602081019050620002f9565b5050509392505050565b600082601f83011262000346576200034562000187565b5b815162000358848260208601620002ba565b91505092915050565b6000602082840312156200037a57620003796200017d565b5b600082015167ffffffffffffffff8111156200039b576200039a62000182565b5b620003a9848285016200032e565b91505092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000819050919050565b6000620004278262000410565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82036200045c576200045b620003e1565b5b600182019050919050565b611e0d80620004776000396000f3fe6080604052600436106100a75760003560e01c80638da5cb5b116100645780638da5cb5b1461021c578063e67e3ad914610247578063e802a85014610272578063e8039e351461029b578063e9073fc6146102d8578063f62aef33146102f4576100a7565b80630cdb0d53146100ac578063210d66f8146100e95780632e559c0d14610128578063593b79fe1461016557806370587c10146101a2578063856ed094146101df575b600080fd5b3480156100b857600080fd5b506100d360048036038101906100ce91906112d0565b61031d565b6040516100e09190611398565b60405180910390f35b3480156100f557600080fd5b50610110600480360381019061010b91906113f0565b610523565b60405161011f9392919061146d565b60405180910390f35b34801561013457600080fd5b5061014f600480360381019061014a91906113f0565b6105f5565b60405161015c9190611398565b60405180910390f35b34801561017157600080fd5b5061018c600480360381019061018791906114d7565b610652565b6040516101999190611398565b60405180910390f35b3480156101ae57600080fd5b506101c960048036038101906101c491906115ea565b61067b565b6040516101d69190611398565b60405180910390f35b3480156101eb57600080fd5b50610206600480360381019061020191906114d7565b610803565b6040516102139190611661565b60405180910390f35b34801561022857600080fd5b50610231610823565b60405161023e919061167c565b60405180910390f35b34801561025357600080fd5b5061025c610849565b6040516102699190611398565b60405180910390f35b34801561027e57600080fd5b506102996004803603810190610294919061175a565b610afa565b005b3480156102a757600080fd5b506102c260048036038101906102bd9190611859565b610bef565b6040516102cf9190611398565b60405180910390f35b6102f260048036038101906102ed91906112d0565b610efb565b005b34801561030057600080fd5b5061031b6004803603810190610316919061175a565b61101d565b005b606060006002835161032f91906118e4565b67ffffffffffffffff811115610348576103476111a5565b5b6040519080825280601f01601f19166020018201604052801561037a5781602001600182028036833780820191505090505b50905060006040518060400160405280601081526020017f3031323334353637383961626364656600000000000000000000000000000000815250905060005b8451811015610518578182518683815181106103d9576103d8611926565b5b602001015160f81c60f81b60f81c60ff166103f49190611984565b8151811061040557610404611926565b5b602001015160f81c60f81b8360028361041e91906118e4565b8151811061042f5761042e611926565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535081825186838151811061047457610473611926565b5b602001015160f81c60f81b60f81c60ff1661048f91906119b5565b815181106104a05761049f611926565b5b602001015160f81c60f81b8360016002846104bb91906118e4565b6104c591906119e6565b815181106104d6576104d5611926565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350808061051090611a1a565b9150506103ba565b508192505050919050565b600260205280600052604060002060009150905080600001805461054690611a91565b80601f016020809104026020016040519081016040528092919081815260200182805461057290611a91565b80156105bf5780601f10610594576101008083540402835291602001916105bf565b820191906000526020600020905b8154815290600101906020018083116105a257829003601f168201915b5050505050908060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060020154905083565b6060602067ffffffffffffffff811115610612576106116111a5565b5b6040519080825280601f01601f1916602001820160405280156106445781602001600182028036833780820191505090505b509050816020820152919050565b6060816040516020016106659190611b0a565b6040516020818303038152906040529050919050565b60606000805b838110156106c55784818151811061069c5761069b611926565b5b602002602001015151826106b091906119e6565b915080806106bd90611a1a565b915050610681565b5060008167ffffffffffffffff8111156106e2576106e16111a5565b5b6040519080825280601f01601f1916602001820160405280156107145781602001600182028036833780820191505090505b5090506000805b858110156107f65760005b87828151811061073957610738611926565b5b6020026020010151518110156107e25787828151811061075c5761075b611926565b5b6020026020010151818151811061077657610775611926565b5b602001015160f81c60f81b84848061078d90611a1a565b9550815181106107a05761079f611926565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535080806107da90611a1a565b915050610726565b5080806107ee90611a1a565b91505061071b565b5081935050505092915050565b60036020528060005260406000206000915054906101000a900460ff1681565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60606000600260005461085c91906119e6565b67ffffffffffffffff811115610875576108746111a5565b5b6040519080825280602002602001820160405280156108a857816020015b60608152602001906001900390816108935790505b5090506040518060400160405280600181526020017f5b00000000000000000000000000000000000000000000000000000000000000815250816000815181106108f5576108f4611926565b5b602002602001018190525060008054905060006001905060005b82811015610a8757610a3e6002600083815260200190815260200160002060405180606001604052908160008201805461094890611a91565b80601f016020809104026020016040519081016040528092919081815260200182805461097490611a91565b80156109c15780601f10610996576101008083540402835291602001916109c1565b820191906000526020600020905b8154815290600101906020018083116109a457829003601f168201915b505050505081526020016001820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001600282015481525050600185610a379190611b25565b8314610bef565b84600183610a4c91906119e6565b81518110610a5d57610a5c611926565b5b602002602001018190525081610a7290611a1a565b91508080610a7f90611a1a565b91505061090f565b506040518060400160405280600181526020017f5d00000000000000000000000000000000000000000000000000000000000000815250838281518110610ad157610ad0611926565b5b6020026020010181905250610af283600183610aed91906119e6565b61067b565b935050505090565b3373ffffffffffffffffffffffffffffffffffffffff16600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614610b5457600080fd5b60008151905060005b81811015610bea57600160036000858481518110610b7e57610b7d611926565b5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055508080610be290611a1a565b915050610b5d565b505050565b60606000606467ffffffffffffffff811115610c0e57610c0d6111a5565b5b604051908082528060200260200182016040528015610c4157816020015b6060815260200190600190039081610c2c5790505b50905060006040518060400160405280600681526020017f7b2272223a220000000000000000000000000000000000000000000000000000815250828280610c8890611a1a565b935081518110610c9b57610c9a611926565b5b6020026020010181905250610cb3856000015161031d565b828280610cbf90611a1a565b935081518110610cd257610cd1611926565b5b60200260200101819052506040518060400160405280600781526020017f222c2261223a2200000000000000000000000000000000000000000000000000815250828280610d1f90611a1a565b935081518110610d3257610d31611926565b5b6020026020010181905250610d52610d4d8660200151610652565b61031d565b828280610d5e90611a1a565b935081518110610d7157610d70611926565b5b60200260200101819052506040518060400160405280600681526020017f2c226f223a220000000000000000000000000000000000000000000000000000815250828280610dbe90611a1a565b935081518110610dd157610dd0611926565b5b6020026020010181905250610df1610dec86604001516105f5565b61031d565b828280610dfd90611a1a565b935081518110610e1057610e0f611926565b5b60200260200101819052508315610e86576040518060400160405280600281526020017f227d000000000000000000000000000000000000000000000000000000000000815250828280610e6390611a1a565b935081518110610e7657610e75611926565b5b6020026020010181905250610ee7565b6040518060400160405280600381526020017f227d2c0000000000000000000000000000000000000000000000000000000000815250828280610ec890611a1a565b935081518110610edb57610eda611926565b5b60200260200101819052505b610ef1828261067b565b9250505092915050565b600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1615610f5257600080fd5b60405180606001604052808281526020013373ffffffffffffffffffffffffffffffffffffffff16815260200160005481525060026000805481526020019081526020016000206000820151816000019081610fae9190611d05565b5060208201518160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506040820151816002015590505060008081548092919061101590611a1a565b919050555050565b3373ffffffffffffffffffffffffffffffffffffffff16600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161461107757600080fd5b60008151905060005b81811015611171576003600084838151811061109f5761109e611926565b5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff161561115e576003600084838151811061110b5761110a611926565b5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81549060ff02191690555b808061116990611a1a565b915050611080565b505050565b6000604051905090565b600080fd5b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6111dd82611194565b810181811067ffffffffffffffff821117156111fc576111fb6111a5565b5b80604052505050565b600061120f611176565b905061121b82826111d4565b919050565b600067ffffffffffffffff82111561123b5761123a6111a5565b5b61124482611194565b9050602081019050919050565b82818337600083830152505050565b600061127361126e84611220565b611205565b90508281526020810184848401111561128f5761128e61118f565b5b61129a848285611251565b509392505050565b600082601f8301126112b7576112b661118a565b5b81356112c7848260208601611260565b91505092915050565b6000602082840312156112e6576112e5611180565b5b600082013567ffffffffffffffff81111561130457611303611185565b5b611310848285016112a2565b91505092915050565b600081519050919050565b600082825260208201905092915050565b60005b83811015611353578082015181840152602081019050611338565b60008484015250505050565b600061136a82611319565b6113748185611324565b9350611384818560208601611335565b61138d81611194565b840191505092915050565b600060208201905081810360008301526113b2818461135f565b905092915050565b6000819050919050565b6113cd816113ba565b81146113d857600080fd5b50565b6000813590506113ea816113c4565b92915050565b60006020828403121561140657611405611180565b5b6000611414848285016113db565b91505092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006114488261141d565b9050919050565b6114588161143d565b82525050565b611467816113ba565b82525050565b60006060820190508181036000830152611487818661135f565b9050611496602083018561144f565b6114a3604083018461145e565b949350505050565b6114b48161143d565b81146114bf57600080fd5b50565b6000813590506114d1816114ab565b92915050565b6000602082840312156114ed576114ec611180565b5b60006114fb848285016114c2565b91505092915050565b600067ffffffffffffffff82111561151f5761151e6111a5565b5b602082029050602081019050919050565b600080fd5b600061154861154384611504565b611205565b9050808382526020820190506020840283018581111561156b5761156a611530565b5b835b818110156115b257803567ffffffffffffffff8111156115905761158f61118a565b5b80860161159d89826112a2565b8552602085019450505060208101905061156d565b5050509392505050565b600082601f8301126115d1576115d061118a565b5b81356115e1848260208601611535565b91505092915050565b6000806040838503121561160157611600611180565b5b600083013567ffffffffffffffff81111561161f5761161e611185565b5b61162b858286016115bc565b925050602061163c858286016113db565b9150509250929050565b60008115159050919050565b61165b81611646565b82525050565b60006020820190506116766000830184611652565b92915050565b6000602082019050611691600083018461144f565b92915050565b600067ffffffffffffffff8211156116b2576116b16111a5565b5b602082029050602081019050919050565b60006116d66116d184611697565b611205565b905080838252602082019050602084028301858111156116f9576116f8611530565b5b835b81811015611722578061170e88826114c2565b8452602084019350506020810190506116fb565b5050509392505050565b600082601f8301126117415761174061118a565b5b81356117518482602086016116c3565b91505092915050565b6000602082840312156117705761176f611180565b5b600082013567ffffffffffffffff81111561178e5761178d611185565b5b61179a8482850161172c565b91505092915050565b600080fd5b600080fd5b6000606082840312156117c3576117c26117a3565b5b6117cd6060611205565b9050600082013567ffffffffffffffff8111156117ed576117ec6117a8565b5b6117f9848285016112a2565b600083015250602061180d848285016114c2565b6020830152506040611821848285016113db565b60408301525092915050565b61183681611646565b811461184157600080fd5b50565b6000813590506118538161182d565b92915050565b600080604083850312156118705761186f611180565b5b600083013567ffffffffffffffff81111561188e5761188d611185565b5b61189a858286016117ad565b92505060206118ab85828601611844565b9150509250929050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006118ef826113ba565b91506118fa836113ba565b9250828202611908816113ba565b9150828204841483151761191f5761191e6118b5565b5b5092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b600061198f826113ba565b915061199a836113ba565b9250826119aa576119a9611955565b5b828204905092915050565b60006119c0826113ba565b91506119cb836113ba565b9250826119db576119da611955565b5b828206905092915050565b60006119f1826113ba565b91506119fc836113ba565b9250828201905080821115611a1457611a136118b5565b5b92915050565b6000611a25826113ba565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203611a5757611a566118b5565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680611aa957607f821691505b602082108103611abc57611abb611a62565b5b50919050565b60008160601b9050919050565b6000611ada82611ac2565b9050919050565b6000611aec82611acf565b9050919050565b611b04611aff8261143d565b611ae1565b82525050565b6000611b168284611af3565b60148201915081905092915050565b6000611b30826113ba565b9150611b3b836113ba565b9250828203905081811115611b5357611b526118b5565b5b92915050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302611bbb7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82611b7e565b611bc58683611b7e565b95508019841693508086168417925050509392505050565b6000819050919050565b6000611c02611bfd611bf8846113ba565b611bdd565b6113ba565b9050919050565b6000819050919050565b611c1c83611be7565b611c30611c2882611c09565b848454611b8b565b825550505050565b600090565b611c45611c38565b611c50818484611c13565b505050565b5b81811015611c7457611c69600082611c3d565b600181019050611c56565b5050565b601f821115611cb957611c8a81611b59565b611c9384611b6e565b81016020851015611ca2578190505b611cb6611cae85611b6e565b830182611c55565b50505b505050565b600082821c905092915050565b6000611cdc60001984600802611cbe565b1980831691505092915050565b6000611cf58383611ccb565b9150826002028217905092915050565b611d0e82611319565b67ffffffffffffffff811115611d2757611d266111a5565b5b611d318254611a91565b611d3c828285611c78565b600060209050601f831160018114611d6f5760008415611d5d578287015190505b611d678582611ce9565b865550611dcf565b601f198416611d7d86611b59565b60005b82811015611da557848901518255600182019150602085019450602081019050611d80565b86831015611dc25784890151611dbe601f891682611ccb565b8355505b6001600288020188555050505b50505050505056fea2646970667358221220375efe17b5476a1312f0eaf552d9c531f57377c07bc4a328bb4aa8e2e46ec61a64736f6c63430008110033";
    new_contract(contract_bytes + cons_cods);
}

// 增加数据管理员
if (args[0] == 2) {
    call_contract(args[1], args[2]);
}

// 删除数据管理员
if (args[0] == 3) {
    CreatePhr();
}

// 确权
if (args[0] == 4) {
    Prepayment(args[1]);
}

// 读取确权列表
if (args[0] == 5) {
    QueryContract("", prikey, 0);
}